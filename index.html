<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Instagram Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#0b0d10; color:#e7edf3}
    .wrap{max-width:1200px; margin:40px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px}
    .badges{display:flex; gap:8px; align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#1a2230; color:#9db2c5; border:1px solid #203046}
    .tabs{display:flex; gap:8px; margin-bottom:20px; border-bottom:1px solid #1c2a3b}
    .tab{padding:12px 20px; cursor:pointer; border-radius:8px 8px 0 0; transition:all 0.2s ease}
    .tab:hover{background:#1a2230}
    .tab.active{background:#1f6feb; color:white}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:16px}
    .card{background:#0f1622; border:1px solid #1c2a3b; border-radius:16px; padding:16px}
    .title{font-weight:600; color:#9db2c5; font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .num{font-size:34px; font-weight:700; margin-top:6px}
    .row{display:flex; gap:14px; align-items:center; margin-top:12px}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid #1c2a3b; background:#0f1622; color:#cfe2f2; cursor:pointer; transition:all 0.2s ease}
    .chip:hover{background:#1a2230; border-color:#2a4a5c}
    .input{flex:1; background:#0f1622; border:1px solid #1c2a3b; color:#cfe2f2; padding:10px 12px; border-radius:10px; transition:border-color 0.2s ease}
    .input:focus{outline:none; border-color:#1f6feb}
    button{background:#1f6feb; color:white; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; transition:background 0.2s ease}
    button:hover{background:#0969da}
    button:disabled{background:#656d76; cursor:not-allowed}
    .muted{color:#9db2c5; font-size:12px}
    .verified{display:none}
    a{color:#8ab4ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .loading{opacity:0.6; pointer-events:none}
    
    /* Config Panel Styles */
    .config-panel{background:#0f1622; border:1px solid #1c2a3b; border-radius:16px; padding:20px; margin-bottom:20px}
    .config-section{margin-bottom:24px}
    .config-section h3{margin:0 0 12px 0; color:#8ab4ff; font-size:16px}
    .config-item{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding:8px 0}
    .config-item label{color:#cfe2f2; font-size:14px; flex:1}
    .config-item .description{color:#9db2c5; font-size:12px; margin-top:4px}
    .toggle{position:relative; display:inline-block; width:50px; height:24px}
    .toggle input{opacity:0; width:0; height:0}
    .slider{position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#656d76; transition:.4s; border-radius:24px}
    .slider:before{position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.4s; border-radius:50%}
    input:checked + .slider{background:#1f6feb}
    input:checked + .slider:before{transform:translateX(26px)}
    .config-input{background:#1a2230; border:1px solid #203046; color:#cfe2f2; padding:6px 10px; border-radius:6px; min-width:120px}
    .config-input:focus{outline:none; border-color:#1f6feb}
    .save-status{padding:8px 12px; border-radius:6px; font-size:12px; margin-left:12px; display:none}
    .save-status.success{background:#0d7037; color:#26d863}
    .save-status.error{background:#7d1a1a; color:#f85149}
    
    /* Enhanced avatar styling */
    #avatar {
      transition: opacity 0.3s ease;
      border-radius: 50%;
      border: 1px solid #1c2a3b;
      background: #0f1622;
      object-fit: cover;
    }
    
    #avatar.loading {
      opacity: 0.6;
    }
    
    #avatar.error {
      background: #1a2230 url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzIiIGN5PSIyNCIgcj0iMTIiIGZpbGw9IiM2NTZkNzYiLz4KPHBhdGggZD0iTTEyIDUyQzEyIDQxIDIwIDMyIDMyIDMyUzUyIDQxIDUyIDUyIiBmaWxsPSIjNjU2ZDc2Ii8+Cjwvc3ZnPgo=') center/32px no-repeat;
    }
    
    @media (max-width: 600px) {
      .wrap{margin:20px auto; padding:0 12px}
      header{flex-direction:column; align-items:stretch; gap:12px}
      .grid{grid-template-columns:1fr; gap:10px}
      .row{flex-wrap:wrap}
      .chip{font-size:11px; padding:5px 8px}
      .tabs{flex-wrap:wrap}
      .config-item{flex-direction:column; align-items:stretch; gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <img id="avatar" 
             alt="Profile Picture" 
             width="64" 
             height="64"
             referrerpolicy="no-referrer"
             crossorigin="anonymous"
             loading="lazy" />
        <div>
          <h1 id="name" style="margin:0 0 6px 0;">Instagram Monitor</h1>
          <div class="muted">
            <span id="username">@username</span>
            <span id="verifiedBadge" class="badge verified" style="background:#0969da; color:white">‚úì Verified</span>
          </div>
        </div>
      </div>
      <div class="badges">
        <span id="methodBadge" class="badge">unknown</span>
        <span id="demoBadge" class="badge" style="background:#fd7e14; color:white">Demo Data</span>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="monitor">üìä Monitor</div>
      <div class="tab" data-tab="config">‚öôÔ∏è Settings</div>
      <div class="tab" data-tab="changes">üìà Changes</div>
      <div class="tab" data-tab="about">‚ÑπÔ∏è About</div>
    </div>

    <!-- Monitor Tab -->
    <div class="tab-content active" id="monitor-tab">
      <div class="row">
        <input id="searchInput" class="input" placeholder="Search username (no @)" />
        <button id="searchBtn">Search</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="chip" data-user="therock">therock</button>
        <button class="chip" data-user="cristiano">cristiano</button>
        <button class="chip" data-user="selenagomez">selenagomez</button>
        <button class="chip" data-user="taylorswift">taylorswift</button>
        <button class="chip" data-user="kimkardashian">kimkardashian</button>
        <a id="rawDataLink" class="chip" href="#" target="_blank" rel="noopener">Raw Data</a>
      </div>

      <div class="grid">
        <div class="card">
          <div class="title">Followers</div>
          <div id="followers" class="num">0</div>
        </div>
        <div class="card">
          <div class="title">Following</div>
          <div id="following" class="num">0</div>
        </div>
        <div class="card">
          <div class="title">Posts</div>
          <div id="posts" class="num">0</div>
        </div>
      </div>

      <div class="muted" style="margin-top:16px; text-align:center">
        Last updated: <span id="lastUpdated">‚Äî</span> ‚Ä¢
        Profile: <a id="profileLink" href="#" target="_blank" rel="noopener">open on Instagram</a> ‚Ä¢
        <a href="https://github.com/arandomguyhere/instagram_monitor/actions" target="_blank" rel="noopener">Monitor Actions</a>
      </div>
    </div>

    <!-- Configuration Tab -->
    <div class="tab-content" id="config-tab">
      <div class="config-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
          <h2 style="margin:0; color:#cfe2f2">Configuration Settings</h2>
          <button id="saveConfigBtn">üíæ Save Settings</button>
          <div id="saveStatus" class="save-status"></div>
        </div>

        <div class="config-section">
          <h3>üîî Notifications</h3>
          <div class="config-item">
            <div>
              <label>Enable Email Notifications</label>
              <div class="description">Get notified about important changes via email</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="enableEmailNotifications">
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <label>SMTP Host</label>
            <input type="text" class="config-input" id="smtpHost" placeholder="smtp.gmail.com">
          </div>
          <div class="config-item">
            <label>SMTP Port</label>
            <input type="number" class="config-input" id="smtpPort" placeholder="587" value="587">
          </div>
          <div class="config-item">
            <label>Email Username</label>
            <input type="email" class="config-input" id="smtpUser" placeholder="your@email.com">
          </div>
          <div class="config-item">
            <label>Email Password</label>
            <input type="password" class="config-input" id="smtpPassword" placeholder="app password">
          </div>
          <div class="config-item">
            <label>Notification Email</label>
            <input type="email" class="config-input" id="notificationEmail" placeholder="notifications@domain.com">
          </div>
        </div>

        <div class="config-section">
          <h3>üì∏ Profile Pictures</h3>
          <div class="config-item">
            <div>
              <label>Detect Profile Picture Changes</label>
              <div class="description">Save and track when users change their profile pictures</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="detectProfilePics" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <div>
              <label>Use HD Quality</label>
              <div class="description">Download higher quality profile pictures</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="useHdPics" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <label>Keep Picture History</label>
            <input type="number" class="config-input" id="keepPicHistory" value="10" min="1" max="50">
          </div>
        </div>

        <div class="config-section">
          <h3>üë• Monitoring Options</h3>
          <div class="config-item">
            <div>
              <label>Track Followers</label>
              <div class="description">Monitor follower changes (may be slow)</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="trackFollowers">
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <div>
              <label>Notify on Milestones</label>
              <div class="description">Get alerts for follower milestones (1K, 10K, etc.)</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="notifyMilestones" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <label>Check Interval (minutes)</label>
            <input type="number" class="config-input" id="checkInterval" value="60" min="5" max="1440">
          </div>
        </div>

        <div class="config-section">
          <h3>üîí Privacy & Security</h3>
          <div class="config-item">
            <div>
              <label>Anonymous Mode</label>
              <div class="description">Don't use stored Instagram sessions</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="anonymousMode">
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <div>
              <label>Rotate User Agents</label>
              <div class="description">Use different browser signatures to avoid detection</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="rotateUserAgents" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="config-section">
          <h3>üìä Data & Export</h3>
          <div class="config-item">
            <div>
              <label>Export to CSV</label>
              <div class="description">Save monitoring data in CSV format</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="exportCsv">
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <label>Keep History (days)</label>
            <input type="number" class="config-input" id="keepHistoryDays" value="30" min="1" max="365">
          </div>
        <div class="config-section">
          <h3>üîß Actions</h3>
          <div class="config-item">
            <div>
              <label>Test Email Configuration</label>
              <div class="description">Send a test email to verify settings</div>
            </div>
            <button id="testEmailBtn" style="background:#fd7e14">üìß Test Email</button>
          </div>
          <div class="config-item">
            <div>
              <label>Manual Monitor Run</label>
              <div class="description">Trigger monitoring for the current user</div>
            </div>
            <button id="triggerMonitorBtn" style="background:#26d863; color:#000">‚ñ∂Ô∏è Run Now</button>
          </div>
          <div class="config-item">
            <div>
              <label>Load Config from Server</label>
              <div class="description">Reload settings from the configuration API</div>
            </div>
            <button id="loadConfigBtn" style="background:#8ab4ff; color:#000">üîÑ Reload</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Changes Tab -->
    <div class="tab-content" id="changes-tab">
      <div class="config-panel">
        <h2 style="margin:0 0 20px 0; color:#cfe2f2">Recent Changes</h2>
        <div id="changesLog">
          <div class="muted" style="text-align:center; padding:40px">
            üìà Change history will appear here when monitoring detects updates
          </div>
        </div>
      </div>
    </div>

    <!-- About Tab -->
    <div class="tab-content" id="about-tab">
      <div class="config-panel">
        <h2 style="margin:0 0 20px 0; color:#cfe2f2">About Instagram Monitor</h2>
        <div style="line-height:1.6">
          <p>This tool monitors Instagram profiles and tracks changes over time. Features include:</p>
          <ul style="color:#9db2c5">
            <li>üë• Follower count tracking</li>
            <li>üì∏ Profile picture change detection</li>
            <li>üìù Bio and profile updates</li>
            <li>üîî Email notifications</li>
            <li>üìä Historical data export</li>
            <li>üéØ Milestone alerts</li>
          </ul>
          <p style="margin-top:20px">
            <strong>Version:</strong> 2.0 Enhanced<br>
            <strong>Source:</strong> <a href="https://github.com/arandomguyhere/instagram_monitor" target="_blank">GitHub Repository</a><br>
            <strong>License:</strong> MIT
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Robust BASE: '' on user site; '/<repo>' on project site
    const parts = location.pathname.split('/').filter(Boolean);
    const BASE = parts.length ? `/${parts[0]}` : '';

    const $  = (q) => document.querySelector(q);
    const txt = (q, v) => { const el=$(q); if (el) el.textContent = v; };
    const show = (q, on=true) => { const el=$(q); if (el) el.style.display = on?'':'none'; };
    const fmt = (n) => (Number(n)||0).toLocaleString();

    // Configuration Management with API Integration
    const API_BASE = 'http://localhost:8080/api';
    let currentUser = 'therock';

    async function loadConfigFromAPI() {
      try {
        const response = await fetch(`${API_BASE}/config`);
        if (response.ok) {
          const data = await response.json();
          return data.success ? data.config : null;
        }
      } catch (e) {
        console.log('API not available, using localStorage');
      }
      return null;
    }

    async function saveConfigToAPI(config) {
      try {
        const response = await fetch(`${API_BASE}/config`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        if (response.ok) {
          const data = await response.json();
          return data.success;
        }
      } catch (e) {
        console.log('API not available, using localStorage');
      }
      return false;
    }

    async function testEmailConfig() {
      try {
        const response = await fetch(`${API_BASE}/test-email`);
        const data = await response.json();
        return data;
      } catch (e) {
        return { success: false, error: 'API not available' };
      }
    }

    async function triggerMonitoring(username) {
      try {
        const response = await fetch(`${API_BASE}/trigger-monitoring`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        const data = await response.json();
        return data;
      } catch (e) {
        return { success: false, error: 'API not available' };
      }
    }

    const defaultConfig = {
      enableEmailNotifications: false,
      smtpHost: '',
      smtpPort: 587,
      smtpUser: '',
      smtpPassword: '',
      notificationEmail: '',
      detectProfilePics: true,
      useHdPics: true,
      keepPicHistory: 10,
      trackFollowers: false,
      notifyMilestones: true,
      checkInterval: 60,
      anonymousMode: false,
      rotateUserAgents: true,
      exportCsv: false,
      keepHistoryDays: 30
    };

    async function loadConfig() {
      // Try to load from API first, then localStorage
      const apiConfig = await loadConfigFromAPI();
      if (apiConfig) {
        // Save to localStorage as backup
        localStorage.setItem('igMonitorConfig', JSON.stringify(apiConfig));
        return apiConfig;
      }
      
      const saved = localStorage.getItem('igMonitorConfig');
      return saved ? {...defaultConfig, ...JSON.parse(saved)} : defaultConfig;
    }

    async function saveConfig(config) {
      // Try to save to API first
      const apiSuccess = await saveConfigToAPI(config);
      if (apiSuccess) {
        // Also save to localStorage as backup
        localStorage.setItem('igMonitorConfig', JSON.stringify(config));
        return true;
      }
      
      // Fallback to localStorage only
      localStorage.setItem('igMonitorConfig', JSON.stringify(config));
      return true;
    }

    function applyConfigToUI(config) {
      Object.keys(config).forEach(key => {
        const element = $(`#${key}`);
        if (element) {
          if (element.type === 'checkbox') {
            element.checked = config[key];
          } else {
            element.value = config[key];
          }
        }
      });
    }

    function collectConfigFromUI() {
      const config = {};
      Object.keys(defaultConfig).forEach(key => {
        const element = $(`#${key}`);
        if (element) {
          if (element.type === 'checkbox') {
            config[key] = element.checked;
          } else if (element.type === 'number') {
            config[key] = parseInt(element.value) || defaultConfig[key];
          } else {
            config[key] = element.value;
          }
        }
      });
      return config;
    }

    // Tab Management
    function initializeTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.getAttribute('data-tab');
          
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update active content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          $(`#${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Save Configuration
    async function initializeConfig() {
      const config = await loadConfig();
      applyConfigToUI(config);

      $('#saveConfigBtn')?.addEventListener('click', async () => {
        const newConfig = collectConfigFromUI();
        const success = await saveConfig(newConfig);
        
        showSaveStatus(success, success ? 'Settings saved successfully!' : 'Failed to save settings');
      });

      // Test Email Button
      $('#testEmailBtn')?.addEventListener('click', async () => {
        const btn = $('#testEmailBtn');
        const originalText = btn.textContent;
        btn.textContent = 'üìß Sending...';
        btn.disabled = true;

        const result = await testEmailConfig();
        showSaveStatus(result.success, result.success ? result.message : result.error);

        btn.textContent = originalText;
        btn.disabled = false;
      });

      // Trigger Monitor Button
      $('#triggerMonitorBtn')?.addEventListener('click', async () => {
        const btn = $('#triggerMonitorBtn');
        const originalText = btn.textContent;
        btn.textContent = '‚ñ∂Ô∏è Running...';
        btn.disabled = true;

        const result = await triggerMonitoring(currentUser);
        showSaveStatus(result.success, result.success ? result.message : result.error);

        if (result.success) {
          // Refresh the current user data
          setTimeout(() => showUser(currentUser), 2000);
        }

        btn.textContent = originalText;
        btn.disabled = false;
      });

      // Load Config Button
      $('#loadConfigBtn')?.addEventListener('click', async () => {
        const btn = $('#loadConfigBtn');
        const originalText = btn.textContent;
        btn.textContent = 'üîÑ Loading...';
        btn.disabled = true;

        const config = await loadConfigFromAPI();
        if (config) {
          applyConfigToUI(config);
          showSaveStatus(true, 'Configuration reloaded from server');
        } else {
          showSaveStatus(false, 'Failed to load configuration from server');
        }

        btn.textContent = originalText;
        btn.disabled = false;
      });
    }

    function showSaveStatus(success, message) {
      const statusEl = $('#saveStatus');
      if (statusEl) {
        statusEl.style.display = 'block';
        statusEl.className = `save-status ${success ? 'success' : 'error'}`;
        statusEl.textContent = success ? `‚úÖ ${message}` : `‚ùå ${message}`;
        
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 5000);
      }
    }

    // Generate unique avatar placeholders
    function generateAvatarPlaceholder(username) {
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        const char = username.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      
      const hue = Math.abs(hash) % 360;
      const saturation = 45 + (Math.abs(hash) % 30);
      const lightness = 35 + (Math.abs(hash) % 20);
      
      const backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      const textColor = lightness > 45 ? '#000' : '#fff';
      
      const initials = username
        .split(/[._-]/)
        .map(part => part.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
      
      const svg = `
        <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <circle cx="32" cy="32" r="32" fill="${backgroundColor}"/>
          <text x="32" y="40" text-anchor="middle" font-family="system-ui" font-size="20" font-weight="600" fill="${textColor}">
            ${initials}
          </text>
        </svg>
      `;
      
      return `data:image/svg+xml;base64,${btoa(svg)}`;
    }

    // Enhanced avatar loading with better fallbacks
    function loadAvatar(data) {
      const img = $('#avatar');
      if (!img) return;
      
      img.className = 'loading';
      img.onerror = null;
      img.onload = null;
      
      const username = data.username || 'user';
      const avatarUrls = [
        data.profile_pic_url_hd,
        data.profile_pic_url,
        data.profile_pic_url_hd ? `https://images.weserv.nl/?url=${encodeURIComponent(data.profile_pic_url_hd)}&w=150&h=150&output=webp` : null,
        data.profile_pic_url ? `https://images.weserv.nl/?url=${encodeURIComponent(data.profile_pic_url)}&w=150&h=150&output=webp` : null,
        'assets/instagram_profile_pic_empty.jpeg',
        generateAvatarPlaceholder(username)
      ].filter(Boolean);
      
      let currentIndex = 0;
      
      function tryNextUrl() {
        if (currentIndex >= avatarUrls.length) {
          console.error('All avatar URLs failed, using generated placeholder');
          img.className = '';
          img.src = generateAvatarPlaceholder(username);
          return;
        }
        
        const url = avatarUrls[currentIndex];
        console.log(`Trying avatar URL ${currentIndex + 1}/${avatarUrls.length}:`, url.substring(0, 100));
        
        img.onerror = () => {
          console.warn(`Avatar URL ${currentIndex + 1} failed`);
          currentIndex++;
          setTimeout(tryNextUrl, 100);
        };
        
        img.onload = () => {
          console.log(`‚úÖ Avatar loaded successfully from URL ${currentIndex + 1}`);
          img.className = '';
        };
        
        img.src = url;
      }
      
      tryNextUrl();
    }

    async function fetchJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${url} -> ${res.status}`);
      return res.json();
    }

    async function loadProfile(user){
      const base = `${BASE}/data/${encodeURIComponent(user)}`;
      const ts = `?ts=${Date.now()}`;

      try {
        const d = await fetchJson(`${base}/monitoring_summary.json${ts}`);
        d.__source = 'summary';
        return d;
      } catch {}
      
      try {
        const q = await fetchJson(`${base}/quick_stats.json${ts}`);
        q.__source = 'quick';
        q.timestamp = q.last_updated || null;
        q.profile_url = q.profile_url || `https://instagram.com/${q.username}`;
        q.data_collection_method = q.method || 'unknown';
        return q;
      } catch {}
      
      throw new Error('No data found');
    }

    function render(d){
      txt('#name', d.full_name || d.username);
      txt('#username', '@' + d.username);
      txt('#followers', fmt(d.followers));
      txt('#following', fmt(d.following));
      txt('#posts', fmt(d.posts));
      txt('#lastUpdated', d.timestamp ? new Date(d.timestamp).toLocaleString() : '‚Äî');

      const link = $('#profileLink');
      if (link) link.href = d.profile_url || `https://instagram.com/${d.username}`;

      loadAvatar(d);

      const method = d.data_collection_method || d.method || 'unknown';
      txt('#methodBadge', method.replace(/_/g,' '));
      show('#verifiedBadge', !!d.is_verified);
      show('#demoBadge', false);

      const raw = $('#rawDataLink');
      if (raw) {
        const filename = d.__source === 'summary' ? 'monitoring_summary.json' : 'quick_stats.json';
        raw.href = `${BASE}/data/${encodeURIComponent(d.username)}/${filename}`;
      }

      // Load changes if available
      loadChangesLog(d.username);
    }

    function renderFallback(user) {
      show('#demoBadge', true);
      txt('#name', 'No Data Available');
      txt('#username', '@' + user);
      txt('#followers','‚Äî'); 
      txt('#following','‚Äî'); 
      txt('#posts','‚Äî');
      txt('#lastUpdated','‚Äî');
      
      const link = $('#profileLink'); 
      if (link) link.href = `https://instagram.com/${user}`;
      
      const img = $('#avatar'); 
      if (img) {
        img.className = '';
        img.onerror = null;
        img.onload = null;
        img.src = generateAvatarPlaceholder(user);
      }
      
      txt('#methodBadge','no data');
      show('#verifiedBadge', false);
      
      const raw = $('#rawDataLink'); 
      if (raw) raw.href = `${BASE}/data/${encodeURIComponent(user)}/quick_stats.json`;
    }

    async function loadChangesLog(username) {
      try {
        const changes = await fetchJson(`${BASE}/data/${encodeURIComponent(username)}/changes_log.json?ts=${Date.now()}`);
        const changesEl = $('#changesLog');
        if (changesEl && changes.entries) {
          changesEl.innerHTML = changes.entries
            .slice(-10) // Last 10 changes
            .reverse()
            .map(change => `
              <div style="border:1px solid #1c2a3b; border-radius:8px; padding:12px; margin-bottom:12px">
                <div style="color:#8ab4ff; font-size:12px; margin-bottom:8px">
                  ${new Date(change.timestamp).toLocaleString()}
                </div>
                ${change.changes_detected.map(c => `<div style="margin-bottom:4px">‚Ä¢ ${c}</div>`).join('')}
              </div>
            `).join('');
        }
      } catch (e) {
        console.log('No changes log found');
      }
    }

    async function showUser(user){
      if (!user) return;
      
      currentUser = user; // Store current user for API calls
      
      const searchInput = $('#searchInput');
      const searchBtn = $('#searchBtn');
      const wrap = $('.wrap');
      
      if (searchInput) searchInput.value = user;
      if (searchBtn) searchBtn.disabled = true;
      if (wrap) wrap.classList.add('loading');
      
      try {
        const data = await loadProfile(user);
        render(data);
        console.log(`‚úÖ Loaded data for @${user} from ${data.__source}`);
      } catch (e) {
        console.warn(`‚ö†Ô∏è No data found for @${user}:`, e.message);
        renderFallback(user);
      } finally {
        if (searchBtn) searchBtn.disabled = false;
        if (wrap) wrap.classList.remove('loading');
      }
    }

    function initializeApp() {
      // Initialize tabs
      initializeTabs();
      
      // Initialize configuration
      initializeConfig();
      
      // Search button click
      $('#searchBtn')?.addEventListener('click', () => {
        const input = $('#searchInput');
        const user = (input?.value || '').trim().replace('@', '');
        if (user) showUser(user);
      });
      
      // Enter key in search input
      $('#searchInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          $('#searchBtn')?.click();
        }
      });
      
      // Quick search chips
      document.querySelectorAll('[data-user]').forEach(el => {
        el.addEventListener('click', () => {
          const user = el.getAttribute('data-user');
          if (user) showUser(user);
        });
      });
      
      // Load initial user from URL or default
      const urlParams = new URLSearchParams(location.search);
      const initial = urlParams.get('u') || urlParams.get('user') || 'therock';
      showUser(initial);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
