<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instagram Monitor Dashboard</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div class="header">
    <h1>ðŸ“Š Instagram Monitor Dashboard</h1>
    <p>Track Instagram profiles with automated monitoring and instant search</p>
  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search username..." />
    <button id="searchBtn">Search</button>
  </div>

  <div class="quick-links">
    <button data-user="bob">bob</button>
    <button data-user="cristiano">cristiano</button>
    <button data-user="therock">therock</button>
    <button data-user="selenagomez">selenagomez</button>
    <a id="rawDataLink" href="#" target="_blank">Raw Data</a>
    <a id="actionsLink" href="https://github.com/arandomguyhere/instagram_monitor/actions" target="_blank">Actions</a>
  </div>

  <div class="profile-card">
    <img id="avatar" class="avatar" src="assets/instagram_profile_pic_empty.jpeg" alt="Profile Picture"/>
    <div class="profile-info">
      <h2 id="name">Name</h2>
      <p id="username">@username</p>
      <div class="badges">
        <span id="verifiedBadge" class="badge verified">âœ“ Verified</span>
        <span id="methodBadge" class="badge method">Anonymous</span>
        <span id="demoBadge" class="badge demo">Demo Data</span>
      </div>
      <p id="bio">â€”</p>
    </div>
  </div>

  <div class="stats">
    <div class="stat">
      <span id="followers">0</span>
      <small>Followers</small>
    </div>
    <div class="stat">
      <span id="following">0</span>
      <small>Following</small>
    </div>
    <div class="stat">
      <span id="posts">0</span>
      <small>Posts</small>
    </div>
  </div>

  <div class="footer">
    <p>Last updated: <span id="lastUpdated">â€”</span></p>
  </div>

  <script>
    const BASE = location.pathname.split('/').slice(0,2).join('/');

    const $ = q => document.querySelector(q);
    const txt = (q,v) => { const el=$(q); if(el) el.textContent=v; };
    const show = (q,on=true)=>{ const el=$(q); if(el) el.style.display=on?'':'none'; };
    const fmt = n => (Number(n)||0).toLocaleString();

    async function fetchJson(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`${url} -> ${res.status}`);
      return res.json();
    }

    async function loadProfile(user){
      const base = `${BASE}/data/${encodeURIComponent(user)}`;
      const ts = `?ts=${Date.now()}`;
      try {
        const data = await fetchJson(`${base}/monitoring_summary.json${ts}`);
        data.__source = 'summary';
        return data;
      } catch {}
      const data = await fetchJson(`${base}/quick_stats.json${ts}`);
      data.__source = 'quick';
      data.timestamp = data.last_updated || null;
      data.profile_url = data.profile_url || `https://instagram.com/${data.username}`;
      data.data_collection_method = data.method || 'unknown';
      return data;
    }

    function render(d){
      txt('#name', d.full_name || d.username);
      txt('#username', '@' + d.username);
      txt('#followers', fmt(d.followers));
      txt('#following', fmt(d.following));
      txt('#posts', fmt(d.posts));
      txt('#lastUpdated', d.timestamp ? new Date(d.timestamp).toLocaleString() : 'â€”');

      const link = $('#profileLink');
      if (link) link.href = d.profile_url || `https://instagram.com/${d.username}`;

      const pic = d.profile_pic_url_hd || d.profile_pic_url || 'assets/instagram_profile_pic_empty.jpeg';
      const img = $('#avatar');
      if (img) img.src = pic + (pic.includes('?') ? '&' : '?') + 'ts=' + Date.now();

      const method = d.data_collection_method || d.method || 'unknown';
      txt('#methodBadge', method.replace('_',' '));
      show('#verifiedBadge', !!d.is_verified);
      show('#demoBadge', false);

      $('#rawDataLink').href = `${BASE}/data/${encodeURIComponent(d.username)}/${d.__source === 'summary' ? 'monitoring_summary.json' : 'quick_stats.json'}`;
    }

    async function showUser(user){
      if (!user) return;
      $('#searchInput').value = user;
      try {
        const data = await loadProfile(user);
        render(data);
      } catch (e){
        console.warn('Fetch failed:', e);
        show('#demoBadge', true);
        txt('#name', 'Demo / Not Found');
        txt('#username', '@' + user);
        txt('#followers','0'); txt('#following','0'); txt('#posts','0');
        txt('#lastUpdated','â€”');
        $('#avatar').src = 'assets/instagram_profile_pic_empty.jpeg';
        txt('#methodBadge','fallback');
        $('#rawDataLink').href = `${BASE}/data/${encodeURIComponent(user)}/quick_stats.json`;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      $('#searchBtn').addEventListener('click', ()=> showUser($('#searchInput').value.trim()));
      $('#searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('#searchBtn').click(); });
      document.querySelectorAll('[data-user]').forEach(el=>{
        el.addEventListener('click', ()=> showUser(el.getAttribute('data-user')));
      });
      const initial = (new URLSearchParams(location.search)).get('u') || 'therock';
      showUser(initial);
    });
  </script>
</body>
</html>
