<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Instagram Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; background:#0b0d10; color:#e7edf3}
    .wrap{max-width:1200px; margin:40px auto; padding:0 16px}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px}
    .badges{display:flex; gap:8px; align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#1a2230; color:#9db2c5; border:1px solid #203046}
    .tabs{display:flex; gap:8px; margin-bottom:20px; border-bottom:1px solid #1c2a3b}
    .tab{padding:12px 20px; cursor:pointer; border-radius:8px 8px 0 0; transition:all 0.2s ease}
    .tab:hover{background:#1a2230}
    .tab.active{background:#1f6feb; color:white}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:16px}
    .card{background:#0f1622; border:1px solid #1c2a3b; border-radius:16px; padding:16px}
    .title{font-weight:600; color:#9db2c5; font-size:12px; letter-spacing:.4px; text-transform:uppercase}
    .num{font-size:34px; font-weight:700; margin-top:6px}
    .row{display:flex; gap:14px; align-items:center; margin-top:12px}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid #1c2a3b; background:#0f1622; color:#cfe2f2; cursor:pointer; transition:all 0.2s ease}
    .chip:hover{background:#1a2230; border-color:#2a4a5c}
    .input{flex:1; background:#0f1622; border:1px solid #1c2a3b; color:#cfe2f2; padding:10px 12px; border-radius:10px; transition:border-color 0.2s ease}
    .input:focus{outline:none; border-color:#1f6feb}
    button{background:#1f6feb; color:white; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; transition:background 0.2s ease}
    button:hover{background:#0969da}
    button:disabled{background:#656d76; cursor:not-allowed; opacity:0.5}
    .muted{color:#9db2c5; font-size:12px}
    .verified{display:none}
    a{color:#8ab4ff; text-decoration:none}
    a:hover{text-decoration:underline}
    .loading{opacity:0.6; pointer-events:none}
    
    /* Config Panel Styles */
    .config-panel{background:#0f1622; border:1px solid #1c2a3b; border-radius:16px; padding:20px; margin-bottom:20px}
    .config-section{margin-bottom:24px}
    .config-section h3{margin:0 0 12px 0; color:#8ab4ff; font-size:16px}
    .config-item{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; padding:8px 0}
    .config-item label{color:#cfe2f2; font-size:14px; flex:1}
    .config-item .description{color:#9db2c5; font-size:12px; margin-top:4px}
    .toggle{position:relative; display:inline-block; width:50px; height:24px}
    .toggle input{opacity:0; width:0; height:0}
    .slider{position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#656d76; transition:.4s; border-radius:24px}
    .slider:before{position:absolute; content:""; height:18px; width:18px; left:3px; bottom:3px; background:white; transition:.4s; border-radius:50%}
    input:checked + .slider{background:#1f6feb}
    input:checked + .slider:before{transform:translateX(26px)}
    .config-input{background:#1a2230; border:1px solid #203046; color:#cfe2f2; padding:6px 10px; border-radius:6px; min-width:120px}
    .config-input:focus{outline:none; border-color:#1f6feb}
    .save-status{padding:8px 12px; border-radius:6px; font-size:12px; margin-left:12px; display:none}
    .save-status.success{background:#0d7037; color:#26d863}
    .save-status.error{background:#7d1a1a; color:#f85149}
    .disabled-notice{background:#1a2230; border:1px solid #656d76; border-radius:8px; padding:12px; margin-bottom:20px; color:#9db2c5; font-size:13px}
    
    /* Enhanced avatar styling */
    #avatar {
      transition: opacity 0.3s ease;
      border-radius: 50%;
      border: 1px solid #1c2a3b;
      background: #0f1622;
      object-fit: cover;
    }
    
    #avatar.loading {
      opacity: 0.6;
    }
    
    @media (max-width: 600px) {
      .wrap{margin:20px auto; padding:0 12px}
      header{flex-direction:column; align-items:stretch; gap:12px}
      .grid{grid-template-columns:1fr; gap:10px}
      .row{flex-wrap:wrap}
      .chip{font-size:11px; padding:5px 8px}
      .tabs{flex-wrap:wrap}
      .config-item{flex-direction:column; align-items:stretch; gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <img id="avatar" 
             alt="Profile Picture" 
             width="64" 
             height="64"
             loading="lazy" />
        <div>
          <h1 id="name" style="margin:0 0 6px 0;">Instagram Monitor</h1>
          <div class="muted">
            <span id="username">@username</span>
            <span id="verifiedBadge" class="badge verified" style="background:#0969da; color:white">‚úì Verified</span>
          </div>
        </div>
      </div>
      <div class="badges">
        <span id="methodBadge" class="badge">unknown</span>
        <span id="statusBadge" class="badge">loading</span>
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tabs">
      <div class="tab active" data-tab="monitor">üìä Monitor</div>
      <div class="tab" data-tab="config">‚öôÔ∏è Settings</div>
      <div class="tab" data-tab="changes">üìà Changes</div>
      <div class="tab" data-tab="about">‚ÑπÔ∏è About</div>
    </div>

    <!-- Monitor Tab -->
    <div class="tab-content active" id="monitor-tab">
      <div class="row">
        <input id="searchInput" class="input" placeholder="Search username (no @)" />
        <button id="searchBtn">Search</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="chip" data-user="therock">therock</button>
        <button class="chip" data-user="cristiano">cristiano</button>
        <button class="chip" data-user="selenagomez">selenagomez</button>
        <button class="chip" data-user="taylorswift">taylorswift</button>
        <button class="chip" data-user="kimkardashian">kimkardashian</button>
        <a id="rawDataLink" class="chip" href="#" target="_blank" rel="noopener">Raw Data</a>
      </div>

      <div class="grid">
        <div class="card">
          <div class="title">Followers</div>
          <div id="followers" class="num">0</div>
        </div>
        <div class="card">
          <div class="title">Following</div>
          <div id="following" class="num">0</div>
        </div>
        <div class="card">
          <div class="title">Posts</div>
          <div id="posts" class="num">0</div>
        </div>
      </div>

      <div class="muted" style="margin-top:16px; text-align:center">
        Last updated: <span id="lastUpdated">‚Äî</span> ‚Ä¢
        Profile: <a id="profileLink" href="#" target="_blank" rel="noopener">open on Instagram</a> ‚Ä¢
        <a href="https://github.com/arandomguyhere/instagram_monitor/actions" target="_blank" rel="noopener">Monitor Actions</a>
      </div>
    </div>

    <!-- Configuration Tab -->
    <div class="tab-content" id="config-tab">
      <div class="config-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
          <h2 style="margin:0; color:#cfe2f2">Local Settings</h2>
          <button id="saveConfigBtn">üíæ Save Locally</button>
          <div id="saveStatus" class="save-status"></div>
        </div>

        <div class="disabled-notice">
          ‚ö†Ô∏è These settings are saved locally in your browser. Email notifications and server features require a backend API that's not available on GitHub Pages.
        </div>

        <div class="config-section">
          <h3>üîî Notification Preferences</h3>
          <div class="config-item">
            <div>
              <label>Enable Email Notifications</label>
              <div class="description">Requires backend server (not available on GitHub Pages)</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="enableEmailNotifications" disabled>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="config-section">
          <h3>üì∏ Display Options</h3>
          <div class="config-item">
            <div>
              <label>Show Profile Pictures</label>
              <div class="description">Display user avatars when available</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="showProfilePics" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <div>
              <label>Use HD Quality</label>
              <div class="description">Load higher quality images when available</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="useHdPics" checked>
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="config-section">
          <h3>üë• View Options</h3>
          <div class="config-item">
            <div>
              <label>Show Milestones</label>
              <div class="description">Highlight follower milestones (1K, 10K, etc.)</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="showMilestones" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div class="config-item">
            <label>Refresh Interval (seconds)</label>
            <input type="number" class="config-input" id="refreshInterval" value="60" min="10" max="300">
          </div>
        </div>
      </div>
    </div>

    <!-- Changes Tab -->
    <div class="tab-content" id="changes-tab">
      <div class="config-panel">
        <h2 style="margin:0 0 20px 0; color:#cfe2f2">Recent Changes</h2>
        <div id="changesLog">
          <div class="muted" style="text-align:center; padding:40px">
            üìà Change history will appear here when monitoring detects updates
          </div>
        </div>
      </div>
    </div>

    <!-- About Tab -->
    <div class="tab-content" id="about-tab">
      <div class="config-panel">
        <h2 style="margin:0 0 20px 0; color:#cfe2f2">About Instagram Monitor</h2>
        <div style="line-height:1.6">
          <p>This tool monitors Instagram profiles and tracks changes over time. Features include:</p>
          <ul style="color:#9db2c5">
            <li>üë• Follower count tracking</li>
            <li>üì∏ Profile picture change detection</li>
            <li>üìù Bio and profile updates</li>
            <li>üìä Historical data tracking</li>
            <li>üéØ Milestone detection</li>
          </ul>
          <p style="margin-top:20px">
            <strong>Version:</strong> 2.1 Fixed<br>
            <strong>Source:</strong> <a href="https://github.com/arandomguyhere/instagram_monitor" target="_blank">GitHub Repository</a><br>
            <strong>License:</strong> MIT
          </p>
          <div style="margin-top:20px; padding:12px; background:#1a2230; border-radius:8px">
            <strong>Note:</strong> This dashboard runs entirely in your browser. Email notifications and remote monitoring require running the Python script with proper credentials.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Detect GitHub Pages deployment
    const isGitHubPages = window.location.hostname.includes('github.io');
    const BASE = isGitHubPages ? '/instagram_monitor' : '';

    const $  = (q) => document.querySelector(q);
    const txt = (q, v) => { const el=$(q); if (el) el.textContent = v; };
    const show = (q, on=true) => { const el=$(q); if (el) el.style.display = on?'':'none'; };
    const fmt = (n) => (Number(n)||0).toLocaleString();

    // HTML escape function to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    let currentUser = 'therock';
    let refreshTimer = null;

    // Local configuration (no API needed)
    const defaultConfig = {
      showProfilePics: true,
      useHdPics: true,
      showMilestones: true,
      refreshInterval: 60
    };

    function loadConfig() {
      try {
        const saved = localStorage.getItem('igMonitorConfig');
        if (saved) {
          return {...defaultConfig, ...JSON.parse(saved)};
        }
      } catch (e) {
        console.warn('Failed to load config from localStorage:', e);
        // Clear corrupted data
        localStorage.removeItem('igMonitorConfig');
      }
      return defaultConfig;
    }

    function saveConfig(config) {
      localStorage.setItem('igMonitorConfig', JSON.stringify(config));
      return true;
    }

    function applyConfigToUI(config) {
      Object.keys(config).forEach(key => {
        const element = $(`#${key}`);
        if (element && !element.disabled) {
          if (element.type === 'checkbox') {
            element.checked = config[key];
          } else {
            element.value = config[key];
          }
        }
      });
    }

    function collectConfigFromUI() {
      const config = {};
      Object.keys(defaultConfig).forEach(key => {
        const element = $(`#${key}`);
        if (element && !element.disabled) {
          if (element.type === 'checkbox') {
            config[key] = element.checked;
          } else if (element.type === 'number') {
            config[key] = parseInt(element.value) || defaultConfig[key];
          } else {
            config[key] = element.value;
          }
        }
      });
      return config;
    }

    // Tab Management
    function initializeTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.getAttribute('data-tab');
          
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Update active content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          $(`#${targetTab}-tab`).classList.add('active');
        });
      });
    }

    // Configuration
    function initializeConfig() {
      const config = loadConfig();
      applyConfigToUI(config);

      $('#saveConfigBtn')?.addEventListener('click', () => {
        const newConfig = collectConfigFromUI();
        const success = saveConfig(newConfig);
        
        showSaveStatus(success, 'Settings saved to browser');
        
        // Apply refresh interval
        if (newConfig.refreshInterval !== config.refreshInterval) {
          setupAutoRefresh(newConfig.refreshInterval);
        }
      });
    }

    function showSaveStatus(success, message) {
      const statusEl = $('#saveStatus');
      if (statusEl) {
        statusEl.style.display = 'block';
        statusEl.className = `save-status ${success ? 'success' : 'error'}`;
        statusEl.textContent = success ? `‚úÖ ${message}` : `‚ùå ${message}`;
        
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      }
    }

    // Avatar generation
    function generateAvatarPlaceholder(username) {
      let hash = 0;
      for (let i = 0; i < username.length; i++) {
        const char = username.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      
      const hue = Math.abs(hash) % 360;
      const saturation = 45 + (Math.abs(hash) % 30);
      const lightness = 35 + (Math.abs(hash) % 20);
      
      const backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      const textColor = lightness > 45 ? '#000' : '#fff';
      
      const initials = username
        .split(/[._-]/)
        .map(part => part.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
      
      const svg = `
        <svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <circle cx="32" cy="32" r="32" fill="${backgroundColor}"/>
          <text x="32" y="40" text-anchor="middle" font-family="system-ui" font-size="20" font-weight="600" fill="${textColor}">
            ${initials}
          </text>
        </svg>
      `;
      
      return `data:image/svg+xml;base64,${btoa(svg)}`;
    }

    // UPDATED: Enhanced avatar loading with multiple fallbacks
    function loadAvatar(data) {
      const img = $('#avatar');
      if (!img) return;
      
      const config = loadConfig();
      if (!config.showProfilePics) {
        img.src = generateAvatarPlaceholder(data.username || 'user');
        return;
      }
      
      img.className = 'loading';
      const username = data.username || 'user';
      
      // Build priority list of image sources
      const imageSources = [];
      
      // Priority 1: Local downloaded file
      if (username) {
        imageSources.push(`${BASE}/monitoring_data/${encodeURIComponent(username)}/profile_pic.jpg?t=${Date.now()}`);
      }
      
      // Priority 2: HD external URL
      if (config.useHdPics && data.profile_pic_url_hd) {
        imageSources.push(data.profile_pic_url_hd);
      }
      
      // Priority 3: Regular external URL
      if (data.profile_pic_url) {
        imageSources.push(data.profile_pic_url);
      }
      
      // Priority 4: Placeholder (always works)
      imageSources.push(generateAvatarPlaceholder(username));
      
      console.log('üñºÔ∏è Trying avatar sources for', username, ':', imageSources.map(s => s.substring(0, 50) + '...'));
      
      tryImageSources(imageSources, img);
    }

    function tryImageSources(sources, imgElement) {
      let currentIndex = 0;

      function tryNext() {
        if (currentIndex >= sources.length) {
          // All sources failed, use placeholder as final fallback
          imgElement.src = generateAvatarPlaceholder('user');
          imgElement.className = '';
          console.log('‚ùå All avatar sources failed, using placeholder');
          return;
        }

        const currentSource = sources[currentIndex];
        if (!currentSource) {
          currentIndex++;
          tryNext();
          return;
        }

        // If this is already a placeholder (SVG), use it directly
        if (currentSource.startsWith('data:image/svg')) {
          imgElement.src = currentSource;
          imgElement.className = '';
          console.log('‚úÖ Using placeholder avatar');
          return;
        }

        const testImg = new Image();
        let handled = false;

        function handleSuccess() {
          if (handled) return;
          handled = true;
          console.log('‚úÖ Avatar loaded:', currentSource.substring(0, 50) + '...');
          imgElement.onload = () => imgElement.className = '';
          imgElement.onerror = () => {
            console.log('‚ö†Ô∏è Avatar loaded in test but failed in main element, trying next');
            currentIndex++;
            tryNext();
          };
          imgElement.src = currentSource;
        }

        function handleFailure(reason) {
          if (handled) return;
          handled = true;
          console.log(`‚ùå Avatar failed (${reason}):`, currentSource.substring(0, 50) + '...');
          currentIndex++;
          tryNext();
        }

        testImg.onload = () => handleSuccess();
        testImg.onerror = () => handleFailure('error');

        // Set a timeout to avoid hanging on slow loads
        setTimeout(() => {
          if (!handled && !testImg.complete) {
            handleFailure('timeout');
          }
        }, 5000);

        testImg.src = currentSource;
      }

      tryNext();
    }

    async function fetchJson(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${url} -> ${res.status}`);
      return res.json();
    }

    async function loadProfile(user) {
      // Fixed paths to match what monitor.py actually creates
      const base = `${BASE}/monitoring_data/${encodeURIComponent(user)}`;
      const ts = `?ts=${Date.now()}`;

      try {
        // Try latest.json (what monitor.py creates)
        const latest = await fetchJson(`${base}/latest.json${ts}`);
        latest.__source = 'latest';
        latest.timestamp = latest.last_updated || new Date().toISOString();
        latest.profile_url = `https://instagram.com/${latest.username}`;
        return latest;
      } catch (e) {
        console.log('latest.json not found, trying history.json');
      }
      
      try {
        // Try history.json as fallback
        const history = await fetchJson(`${base}/history.json${ts}`);
        if (history && history.length > 0) {
          const latest = history[history.length - 1].snapshot;
          latest.__source = 'history';
          latest.timestamp = latest.last_updated || history[history.length - 1].timestamp;
          latest.profile_url = `https://instagram.com/${latest.username}`;
          return latest;
        }
      } catch (e) {
        console.log('history.json not found');
      }
      
      throw new Error('No data found');
    }

    function render(d) {
      txt('#name', d.full_name || d.username);
      txt('#username', '@' + d.username);
      txt('#followers', fmt(d.followers));
      txt('#following', fmt(d.following || d.followees));
      txt('#posts', fmt(d.posts || d.mediacount));
      txt('#lastUpdated', d.timestamp ? new Date(d.timestamp).toLocaleString() : '‚Äî');

      const link = $('#profileLink');
      if (link) link.href = d.profile_url || `https://instagram.com/${d.username}`;

      // Enhanced avatar loading with debugging
      loadAvatar(d);
      
      // Debug log
      console.log('üìä Profile data loaded:', {
        username: d.username,
        has_profile_pic_url: !!d.profile_pic_url,
        profile_pic_url_preview: d.profile_pic_url ? d.profile_pic_url.substring(0, 100) + '...' : 'none',
        local_profile_pic: d.local_profile_pic,
        followers: d.followers,
        source: d.__source
      });

      txt('#methodBadge', d.schema === 'v1' ? 'monitored' : 'unknown');
      txt('#statusBadge', 'live data');
      show('#verifiedBadge', !!d.is_verified);

      const raw = $('#rawDataLink');
      if (raw) {
        raw.href = `${BASE}/monitoring_data/${encodeURIComponent(d.username)}/latest.json`;
      }

      // Load changes if available
      loadChangesFromHistory(d.username);
    }

    function renderFallback(user) {
      txt('#name', 'No Data Yet');
      txt('#username', '@' + user);
      txt('#followers','‚Äî'); 
      txt('#following','‚Äî'); 
      txt('#posts','‚Äî');
      txt('#lastUpdated','Never');
      
      const link = $('#profileLink'); 
      if (link) link.href = `https://instagram.com/${user}`;
      
      const img = $('#avatar'); 
      if (img) {
        img.className = '';
        img.src = generateAvatarPlaceholder(user);
      }
      
      txt('#methodBadge','no data');
      txt('#statusBadge', 'pending');
      show('#verifiedBadge', false);
      
      const raw = $('#rawDataLink'); 
      if (raw) raw.href = `${BASE}/monitoring_data/${encodeURIComponent(user)}/latest.json`;
    }

    async function loadChangesFromHistory(username) {
      try {
        const history = await fetchJson(`${BASE}/monitoring_data/${encodeURIComponent(username)}/history.json?ts=${Date.now()}`);
        const changesEl = $('#changesLog');
        
        if (changesEl && history && history.length > 0) {
          // Extract changes from history
          const changes = [];
          for (let i = 1; i < history.length && changes.length < 10; i++) {
            const entry = history[history.length - i];
            if (entry.changes && Object.keys(entry.changes).length > 0) {
              changes.push({
                timestamp: entry.timestamp,
                changes: entry.changes
              });
            }
          }
          
          if (changes.length > 0) {
            changesEl.innerHTML = changes.map(change => {
              const changeDescriptions = Object.entries(change.changes).map(([key, val]) => {
                // Escape values to prevent XSS
                const oldVal = typeof val.old === 'string' ? escapeHtml(val.old) : val.old;
                const newVal = typeof val.new === 'string' ? escapeHtml(val.new) : val.new;

                if (key === 'followers') return `Followers: ${fmt(val.old)} ‚Üí ${fmt(val.new)}`;
                if (key === 'following') return `Following: ${fmt(val.old)} ‚Üí ${fmt(val.new)}`;
                if (key === 'posts') return `Posts: ${fmt(val.old)} ‚Üí ${fmt(val.new)}`;
                if (key === 'biography') return `Bio updated`;
                if (key === 'full_name') return `Name: ${oldVal} ‚Üí ${newVal}`;
                if (key === 'is_private') return val.new ? `Account made private` : `Account made public`;
                if (key === 'is_verified') return val.new ? `‚úì Verified` : `Verification removed`;
                return `${escapeHtml(key)} changed`;
              });

              return `
                <div style="border:1px solid #1c2a3b; border-radius:8px; padding:12px; margin-bottom:12px">
                  <div style="color:#8ab4ff; font-size:12px; margin-bottom:8px">
                    ${escapeHtml(new Date(change.timestamp).toLocaleString())}
                  </div>
                  ${changeDescriptions.map(c => `<div style="margin-bottom:4px">‚Ä¢ ${c}</div>`).join('')}
                </div>
              `
            }).join('');
          } else {
            changesEl.innerHTML = '<div class="muted" style="text-align:center; padding:40px">No changes detected yet</div>';
          }
        }
      } catch (e) {
        console.log('Could not load changes:', e);
      }
    }

    async function showUser(user) {
      if (!user) return;
      
      currentUser = user;
      
      const searchInput = $('#searchInput');
      const searchBtn = $('#searchBtn');
      const wrap = $('.wrap');
      
      if (searchInput) searchInput.value = user;
      if (searchBtn) searchBtn.disabled = true;
      if (wrap) wrap.classList.add('loading');
      
      try {
        const data = await loadProfile(user);
        render(data);
        console.log(`‚úÖ Loaded data for @${user}`);
      } catch (e) {
        console.warn(`‚ö†Ô∏è No data found for @${user}:`, e.message);
        renderFallback(user);
      } finally {
        if (searchBtn) searchBtn.disabled = false;
        if (wrap) wrap.classList.remove('loading');
      }
    }

    function setupAutoRefresh(seconds) {
      if (refreshTimer) clearInterval(refreshTimer);
      if (seconds && seconds > 0) {
        refreshTimer = setInterval(() => {
          if (currentUser) showUser(currentUser);
        }, seconds * 1000);
      }
    }

    function initializeApp() {
      // Initialize tabs
      initializeTabs();
      
      // Initialize configuration
      initializeConfig();
      
      // Search functionality
      $('#searchBtn')?.addEventListener('click', () => {
        const input = $('#searchInput');
        const user = (input?.value || '').trim().replace('@', '');
        if (user) showUser(user);
      });
      
      $('#searchInput')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          $('#searchBtn')?.click();
        }
      });
      
      // Quick search chips
      document.querySelectorAll('[data-user]').forEach(el => {
        el.addEventListener('click', () => {
          const user = el.getAttribute('data-user');
          if (user) showUser(user);
        });
      });
      
      // Load initial user
      const urlParams = new URLSearchParams(location.search);
      const initial = urlParams.get('u') || urlParams.get('user') || 'therock';
      showUser(initial);
      
      // Setup auto-refresh
      const config = loadConfig();
      setupAutoRefresh(config.refreshInterval);
    }

    // Start app
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
